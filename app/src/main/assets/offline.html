<!doctype html>
<html lang="pt-br">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Reconectando…</title>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
  :root{color-scheme:light only}
  body{font-family:system-ui,Arial,sans-serif;margin:0;display:grid;place-items:center;min-height:100vh;background:#f7f7f7}
  .card{max-width:460px;margin:24px;padding:24px;text-align:center;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);background:#fff}
  h1{font-size:18px;margin:0 0 8px}
  p{color:#555;margin:0 0 16px}
  button{padding:10px 14px;border:0;border-radius:12px;cursor:pointer;background:#0a7cff;color:#fff}
  button[disabled]{opacity:.6;cursor:not-allowed}
  small{display:block;margin-top:10px;color:#777;min-height:1.2em}
</style>

<div class="card" role="status" aria-live="polite">
  <h1>Sem conexão</h1>
  <p>Estamos tentando reconectar…</p>
  <button id="tryBtn" type="button">Tentar agora</button>
  <small id="status">Aguardando rede…</small>
</div>

<script>
(() => {
  const TRY_TIMEOUT_MS = 4000;     // tempo máx. por tentativa de fetch
  const COOLDOWN_MS    = 3000;     // trava anti-toque repetido

  const $status = document.getElementById('status');
  const $try    = document.getElementById('tryBtn');

  const setStatus = (t) => { if ($status) $status.textContent = t || ''; };

  const withTimeout = (p, ms) => Promise.race([
    p, new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), ms))
  ]);

  // Teste real de conectividade (sem expor endpoints na interface)
  async function probeConnectivity() {
    const candidates = ['.', 'favicon.ico'];
    for (const path of candidates) {
      try {
        const res = await withTimeout(fetch(path, {
          method: 'GET',
          cache: 'no-store',
          credentials: 'include',
          headers: {'Cache-Control':'no-store','Pragma':'no-cache'}
        }), TRY_TIMEOUT_MS);
        if (res && res.ok) return true;
      } catch(_) { /* tenta próximo */ }
    }
    return false;
  }

  let cooling = false;
  async function onTry() {
    if (cooling) return;
    cooling = true;
    $try.disabled = true;
    setStatus('Verificando conexão…');

    try {
      const ok = await probeConnectivity();
      if (ok) {
        setStatus('Conexão restabelecida. Atualizando…');
        // Recarrega a MESMA URL, sem expor rota
        location.reload();
        return;
      }
      setStatus('Ainda sem resposta do servidor. Tente novamente em alguns segundos.');
    } finally {
      setTimeout(() => {
        cooling = false;
        $try.disabled = false;
      }, COOLDOWN_MS);
    }
  }

  // Nenhum evento automático que provoque reload.
  // Nada de online/visibilitychange/setInterval — só no botão.
  $try?.addEventListener('click', onTry);

  // Mensagem inicial
  setStatus('Aguardando rede…');
})();
</script>
</html>
